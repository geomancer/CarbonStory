<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Exerpts from a Carbon Story The Past, Present, and Future</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="R3MFinalProject_files/libs/clipboard/clipboard.min.js"></script>
<script src="R3MFinalProject_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="R3MFinalProject_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="R3MFinalProject_files/libs/quarto-html/popper.min.js"></script>
<script src="R3MFinalProject_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="R3MFinalProject_files/libs/quarto-html/anchor.min.js"></script>
<link href="R3MFinalProject_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="R3MFinalProject_files/libs/quarto-html/quarto-syntax-highlighting-b30e670e5601cfaa85bdef5efa539e15.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="R3MFinalProject_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="R3MFinalProject_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="R3MFinalProject_files/libs/bootstrap/bootstrap-639c9de20693acacab1bb806dd916cb4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


<link rel="stylesheet" href="styles.css">
</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">
<div class="custom-header-logo">

  <img src="ThinBlueLine.png" alt="Atmosphere logo">

</div>

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Exerpts from a Carbon Story<br>The Past, Present, and Future</h1>
<p class="subtitle lead">Author: David Takahashi<br>December 2025</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="davids-final-project" class="level2">
<h2 class="anchored" data-anchor-id="davids-final-project">David’s Final Project</h2>
<p>I have been learning how to incorporate data visualization in my workflow. In order to do this I started a personal project that documents the discovery of Climate Change. This has meant finding publicly available data archives, downloading them, loading and cleaning the data, and then using the data frames to render visualizations.</p>
<p>This is an excerpt of my progress. The header is a shot of the thin atmosphere that reaches 63 miles above the ground. If the Earth were a basketball, our atmosphere would be like shrink wrapping. The atmosphere is where much of the climate change action is happening.</p>
<p>Fasten your seat belts, folks.</p>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>David’s late father-in-law, David Keeling, was an Earth Scientist who recorded the concentration of CO<sub>2</sub> in the atmosphere daily, starting in 1958. In visits to his daughter, we would take long walks that allowed me to understand his research. The concentration of CO<sub>2</sub> is measured in parts-per-million, and CO<sub>2</sub> comprises 0.04% of the atmosphere. With the accurate data, scientists were able to predict the consequences of rising CO<sub>2</sub> concentrations.</p>
<p>David’s home burned to the ground in a wildfire outside Boulder, CO in September 2010. The wildfire was a predicted consequence of global warming.</p>
</section>
<section id="the-keeling-curve" class="level2">
<h2 class="anchored" data-anchor-id="the-keeling-curve">The Keeling Curve</h2>
<p>There has been mounting evidence that the climate is changing due to increased heating of the atmosphere. The record we know as the Keeling Curve provided circumstantial evidence that the increased concentration of CO<sub>2</sub> is rising, with it global temperatures, and that the rise is attributed to the burning of fossil fuels. I decided I would begin my research by locating, downloading, and graphing the data that has been recorded since 1958. Here is the chart: the saw-tooth behavior and the year-over-year rising are notable:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R3MFinalProject_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In 1958 David Keeling began accurately recording the concentration of CO<sub>2</sub> in the northern hemisphere. The first few years he was puzzled by the rising and falling of the concentration. He thought his instrumentation might be faulty. His tests verified that his instruments were reading reference samples accurately. The first 3 years of data looked like this:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R3MFinalProject_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>After three years of data collection, it became clear that the concentration of CO<sub>2</sub> rose and fell on a seasonal cycle. What had initially looked like faulty instrumentation turned out to be the rise of CO<sub>2</sub> in the winter when photosynthesis was curtailed and the falling when trees were fully leafed out and photosynthesizing CO<sub>2</sub>. This was a surprising revelation. This rising a falling, year after year was recognized as the Earth respiring just as we do.</p>
</section>
<section id="the-suess-effect" class="level2">
<h2 class="anchored" data-anchor-id="the-suess-effect">The Suess Effect:</h2>
<p>That the concentration was rising became obvious. But why the steady increase? The Suess Effect is crucial for climate science because it’s a fingerprint of human activity, showing a dilution of heavier carbon isotopes (<sup>13</sup>C and <sup>14</sup>C) in the atmosphere and oceans due to burning fossil fuels, which releases carbon lacking these isotopes. It provides undeniable proof that rising CO<sub>2</sub> levels stem from fossil fuels, not natural cycles, helping attribute climate change to human actions and serving as a baseline for tracking carbon uptake by oceans and land, informing climate models and mitigation strategies.</p>
<p>This fingerprint of human activity, showing a dilution of heavier carbon isotopes <sup>13</sup>C and <sup>14</sup>C in the atmosphere and oceans due to burning fossil fuels, which releases carbon lacking these isotopes. It provides undeniable proof that rising CO<sub>2</sub> levels stem from fossil fuels, not natural cycles, helping attribute climate change to human actions and serving as a baseline for tracking carbon uptake by oceans and land, informing climate models and mitigation strategies. Here we see as CO<sub>2</sub> levels rise the increasing <sup>12</sup>C from fossil fuels decreases the <sup>13</sup>C/<sup>12</sup>C ratio:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R3MFinalProject_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-historical-record" class="level2">
<h2 class="anchored" data-anchor-id="the-historical-record">The Historical Record</h2>
<p>It turns out that we can measure the temperature record over the last 150,000 years. To do this I chose to use the Vostok and Law Dome historical data. Vostok and Law Dome measure historical temperatures using ice cores, analyzing the ratios of heavy to light oxygen and hydrogen isotopes (like Deuterium) in water molecules, which vary with past air temperatures, and also by studying air bubbles trapped in the ice to find ancient greenhouse gas levels, correlating these proxies to reconstruct past climate, with Vostok famous for long CO<sub>2</sub> records and Law Dome for high-resolution recent data.</p>
<p>Combining these data sets give us the well-known hockey stick chart. I have chosen to depict this a three layer chart which shows the measurements over the last 160,000 years, over the 12,000 Holocene years, and over the 50 years of the Anthropocene.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R3MFinalProject_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="evidence-of-global-warming" class="level2">
<h2 class="anchored" data-anchor-id="evidence-of-global-warming">Evidence of Global Warming</h2>
<p>Climate stripes visually show global warming by using colored bars (stripes) for each year, with blues for cooler-than-average years and reds for warmer years, revealing a stark, undeniable shift from cool blues to intense reds, directly correlating with the rise of human-emitted greenhouse gases like CO<sub>2</sub> that trap heat and cause this warming trend. The darker the shade, the further the temperature deviates from the long-term average, making the rapid increase in recent decades visually clear and impactful.</p>
<p>Though I have downloaded temperature data from ice-core and tree-ring data. I have chosen to only show the years covered by the Keeling curve to suggest how global mean temperature tracks with increasing CO<sub>2</sub> concentrations:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R3MFinalProject_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="co2-level-rise-as-rising-temperature" class="level2">
<h2 class="anchored" data-anchor-id="co2-level-rise-as-rising-temperature">CO<sub>2</sub> Level Rise as Rising Temperature</h2>
<p>This leads to inquire whether we can display the CO<sub>2</sub> effect on global temperature in a single graph. Here is an attempt to distill how the increasing levels of atmospheric CO<sub>2</sub> are affecting global temperatures:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R3MFinalProject_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="so-why-do-we-care-if-the-climate-changes" class="level2">
<h2 class="anchored" data-anchor-id="so-why-do-we-care-if-the-climate-changes">So, why do we care if the climate changes?</h2>
<section id="consequence-1-increasingly-frequent-and-intense-climate-disasters" class="level3">
<h3 class="anchored" data-anchor-id="consequence-1-increasingly-frequent-and-intense-climate-disasters">Consequence #1: increasingly frequent and intense climate disasters</h3>
<p>There’s a strong positive correlation: as CO<sub>2</sub> levels and global temperatures rise, the frequency and cost of billion-dollar climate disasters (like hurricanes, floods, droughts) also significantly increase, demonstrating that rising greenhouse gases are directly linked to escalating economic burdens from extreme weather events, according to studies analyzing U.S. data from 1980-2021. Here, we look at the accumulated cost of the recorded billion dollar events since 1980.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R3MFinalProject_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="consequence-2-glacial-loss-around-the-world" class="level3">
<h3 class="anchored" data-anchor-id="consequence-2-glacial-loss-around-the-world">Consequence #2: Glacial loss around the world</h3>
<p>CO<sub>2</sub> concentration and glacial retreat have a strong, intertwined relationship: higher CO<sub>2</sub> causes warming, leading to glacier melt, while melting ice reduces Earth’s reflectivity (albedo), causing more heat absorption, and warm oceans release trapped CO<sub>2</sub>, creating a dangerous positive feedback loop that amplifies warming and accelerates retreat, making it a critical indicator of climate change’s severity. It matters because this cycle drives sea-level rise, alters water resources, and releases more greenhouse gases (like methane and CO<sub>2</sub> from fungi/soil), impacting ecosystems and human communities globally. The Correlation: A Vicious Cycle.</p>
<p>Here we look at a before and after look at glaciers around the world using global mapping tools:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R3MFinalProject_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="consequence-3-sea-level-rise" class="level3">
<h3 class="anchored" data-anchor-id="consequence-3-sea-level-rise">Consequence #3: Sea Level Rise</h3>
<p>Higher CO<sub>2</sub> levels trap heat, warming the planet, which directly causes sea level rise through melting ice (glaciers, ice sheets) and thermal expansion (warm water taking up more space), a critical issue because rising seas threaten coastal communities, infrastructure, economies, and ecosystems with flooding, erosion, and saltwater intrusion, impacting millions globally. This correlation is strong over geological time and current human-caused warming amplifies it, though sea level response lags behind immediate warming due to ocean and ice inertia, meaning effects persist for centuries.</p>
<p>For instance, here is a 50 mile radius around San Francisco, CA. If sea level rises 1.5m you will see purple…and at 2m rise you see red. We can do this by generating an area map, then using a high resolution Digital Elevation Model (DEM) to query a locations elevation above sea level, and using this to color a dot over the map. The current implementation only does locations in the U.S.: other countries may or may not have publicly available data available.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R3MFinalProject_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="what-i-learned" class="level2">
<h2 class="anchored" data-anchor-id="what-i-learned">What I learned</h2>
<p>The workflow I developed looks something like this:</p>
<ol type="1">
<li><p>What question do you wish to ask?</p></li>
<li><p>Where is data that supports that question?</p></li>
<li><p>Download that data and place it in a raw data folder.</p></li>
<li><p>Move that raw data into an RDS file in a ‘cleaned’ data folder, doing any cleaning, joining, or conversion as you go. This data drives the graphical representation.</p></li>
<li><p>Use the ‘cleaned’ data to create a chart. The question asked will help determine the charting method (line, bar, map, facet) that fits the stated purpose. Refine the chart using best practices and standard theming into a ‘final’ data visualization. Use the RStudio plot pane as a quick view, but always save an image to ensure the final Quarto image is legible.</p></li>
<li><p>Consider these ‘final’ visualizations as ingredients to be assembled in a Quarto document.</p></li>
<li><p>Assemble this final document.</p></li>
</ol>
<p>This pattern tended to repeat itself over the evolution of the report. Every graph shown, and many others not shown, were exercises in asking for data, finding it, cleaning it, using it to create a visualization. I believe this is the ‘general’ workflow in data visualization work.</p>
</section>
<section id="addendum" class="level2">
<h2 class="anchored" data-anchor-id="addendum">Addendum</h2>
<p>A couple of things really stood out about this project.</p>
<section id="the-r-community" class="level3">
<h3 class="anchored" data-anchor-id="the-r-community">The R community</h3>
<p>The first is the rich ecology of the R community. The ability to handle this workflow with such ease, and the extensible nature of the Grammar of Graphics made this excursion a true joy. This used to be an expensive foray into expensive graphics platforms like Tableaux, but this experience simply cost me time: time I would have spent learning any graphics platform. When I needed something new, the R community generally had made a package available to accomplish a new required feature or visualization.</p>
</section>
<section id="public-domain-data" class="level3">
<h3 class="anchored" data-anchor-id="public-domain-data">Public domain data</h3>
<p>The Trump administration has formally announced its intent to dismantle the National Center for Atmospheric Research (NCAR) and has proposed massive budget cuts to the National Oceanic and Atmospheric Administration (NOAA), which would eliminate its core climate and weather research functions.</p>
<p>Much of data I needed to find has been archived by either NCAR or NOAA. This data is global in scope. Losing access to it will be a incredible loss of relevant information about our world. Losing it is like losing our sight or sense of touch. We will be stumbling around in the dark.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>